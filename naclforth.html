<html>
  <head>
    <title>Native Client Forth</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href="/favicon.ico" rel="SHORTCUT ICON">
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
  </head>
  <body bgcolor="#000000"
        link="#0000ff"
        alink="#0000ff"
        vlink="#0000ff"><font color="#ffffff">
    <div id="login" align="right">
    {% if signed_in %}
      <font color="#777777">[ {{ email }} ]</font>
      <a href="{{ sign_out }}">Sign out</a>
    {% else %}
      <a href="{{ sign_in }}">Sign in</a>
    {% endif %}
    </div>

    <div id="listener">
      <script type="text/javascript">
        var forth;
        var cursor_text = '|';
        var out_buffer = '';
        var event_buffer = '';

        function startEvents() {
          document.onkeypress = function(evt) {
            var ch = evt.which;
            if (ch == undefined) ch = evt.keyCode;
            event_buffer += String.fromCharCode(ch));
            return false;
          };
          document.onkeydown = function(evt) {
            event_buffer += String.fromCharCode(evt.keyCode + 256));
            if (evt.keyCode == 8) return false;
            return true;
          };
          document.onkeyup = function(evt) {
            event_buffer += String.fromCharCode(evt.keyCode + 512));
            if (evt.keyCode == 8) return false;
            return true;
          };
        }
  
        function refreshOut() {
          var out = document.getElementById('out');
          out.innerHTML = out_buffer + cursor_text;
        }

        function httpRequest(url, method, values, callback) {
          var request = new XMLHttpRequest();
          request.overrideMimeType('text/plain; charset=x-user-defined');
          request.onreadystatechange = function() {
            if (request.readyState == 4) {
              callback(request.status, request.responseText);
            }
          };
          request.open(method, url);
          if (method == 'POST') {
            //request.setRequestHeader('Content-Type',
            //    'application/x-www-form-urlencoded');
            //request.setRequestHeader('Content-Type', 'multipart/form-data');
            var fd = new FormData();
            for (key in values) {
              fd.append(key, values[key]);
            }
            request.send(fd);
          } else {
            request.send(null);
          }
        };

        function handleMessage(msg) {
          var prefix = msg.data.substr(0, 1);
          var rest = msg.data.substr(1);
          if (prefix == 'a') {
            alert(rest);
          } else if (prefix == 'j') {
            eval(rest);
          } else if (prefix == 'c') {
            cursor_text = rest;
            refreshOut();
          } else if (prefix == 'p') {
            out_buffer = '';
            refreshOut();
          } else if (prefix == 'o') {
            out_buffer += rest;
            refreshOut();
          } else if (prefix == 'i') {
            forth.postMessage(event_buffer);
            event_buffer = '';
          } else if (prefix == 'h') {
          } else {
            alert('Unknown message prefix "' + prefix + '"');
          }
        }
        
        function moduleDidLoad() {
          httpRequest('{{ boot }}', 'GET', {}, function(status, text) {
            if (status != 200) {
              alert('Unable to load boot code!');
              return;
            }
            startEvents();
            forth = document.getElementById('forth');
            forth.addEventListener('message', handleMessage);
            forth.postMessage(text);
          });
        }

        document.getElementById('listener').addEventListener(
            'load', moduleDidLoad, true);
      </script>
      <embed type="application/x-nacl" id="forth"
             width="0" height="0" src="naclforth.nmf"/>
    </div>

    <div id="out"></div>
  </font></body>
</html>
