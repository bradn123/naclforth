<html>
  <head>
    <title>Native Client Forth</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href="/favicon.ico" rel="SHORTCUT ICON">
    <link href="http://prismforth.appspot.com/favicon.png"
     rel="apple-touch-icon-precomposed">
    <meta name="viewport" content="width=device-width">
    <meta name="viewport" content="initial-scale=1.0">
    <meta name="viewport" content="maximum-scale=1.0">
    <meta name="viewport" content="user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style"
     content="black-translucent"/>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
  </head>
  <body onload="init()" bgcolor="#000000">
    <embed type="application/x-nacl-srpc" id="forth"
           name="forth" width="0" height="0" src="forth.nexe" />

    <div id="out"></div>

    <script type="text/javascript">
      //<![CDATA[

      var forth;
      var pending_out = [];

      function http_get(url, callback) {
        var request = new XMLHttpRequest();
        request.overrideMimeType('text/plain; charset=x-user-defined');
        request.onreadystatechange = function() {
          if (request.readyState == 4) {
            if (request.status == 200) {
              callback(request.responseText);
            } else {
              callback(null);
            }
          }
        }
        request.open('GET', url);
        request.send(null);
      }

      function check_for_ready(forth, complete) {
        if (forth.__moduleReady == 1) {
          complete();
        } else if (forth.__moduleReady == 0) {
          setTimeout(function() { check_for_ready(forth, complete) }, 100);
        } else {
          alert("nacl module load failed - canary chrome required");
        }
      }

      function decode_blocks(data) {
        var values = [];
        var length = data.length;
        for (var i = 0; i < length; i+=4) {
          var a = data.charCodeAt(i + 0);
          if (a > 255) a -= 63232; 
          var b = data.charCodeAt(i + 1);
          if (b > 255) b -= 63232; 
          var c = data.charCodeAt(i + 2);
          if (c > 255) c -= 63232; 
          var d = data.charCodeAt(i + 3);
          if (d > 255) d -= 63232; 
          var x = a | (b<<8) | (c<<16) | (d<<24);
          values.push(x);
        }
        return values;
      }

      function decode_string(values) {
        return String.fromCharCode.apply(this, values);
      }

      function keypress(evt) {
        var ch = evt.which;
        if (ch == undefined) ch = evt.keyCode;
        forth.send([1, ch]);
        return false;
      }

      function keydown(evt) {
        forth.send([1, evt.keyCode + 256]);
        if (evt.keyCode == 8) return false;
        return true;
      }

      function keyup(evt) {
        forth.send([1, -evt.keyCode]);
        if (evt.keyCode == 8) return false;
        return true;
      }

      function tick() {
        for(;;) {
          var msg = forth.receive(10000);
          if (!msg.length) break;

          if (msg[0] == 8) {
            pending_out.push(decode_string(msg.slice(1)));
          } else if (msg[0] == 16) {
            var out = document.getElementById('out');
            out.innerHTML = pending_out.join('');
            pending_out = [];
          } else {
            alert(msg);
          }
        }
      }

      function start_events() {
        document.onkeypress = keypress;
        document.onkeydown = keydown;
        document.onkeyup = keyup;
        setInterval(tick, 30);
      }

      function boot(data) {
        forth = document.getElementById("forth");
        check_for_ready(forth, function() {
          var values = decode_blocks(data);
          forth.boot(values, 0);
          start_events();
        });
      }

      function init() {
        http_get("forth.boot", boot);
      }

      //]]>
    </script>
  </body>
</html>

